<!DOCTYPE html>
<html>

<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

<script>
$(document).ready(function(){

   	// from https://docs.djangoproject.com/en/dev/ref/csrf/#ajax
    // Here we fetch the django CSRF (Cross Site Request Forgery) cookie (a nonce??).
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }//getCookie
    
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }//crsfSafe
    
    //refactor and stuff. here, just pissing around
    function  ajaxREST(first_name, type, data_for_put_or_null, success_callback){
    	rest_url = "/apiperson/" + first_name + "/";
		console.log("about to make ajax " + type + " call to endpoint url: " + rest_url);
   	    $.ajax({ 
   	     	url: rest_url,
   	        type: type, 
   	        jsonp: "callback", 
   	        data: data_for_put_or_null,
   	        success: success_callback,
   	        error: function(exception){
   	            var msg = "ajax " + type + " call failed. Exception responseText:" + exception.responseText + " status:" + exception.status;
   	            console.log(msg);
   	            alert(msg);
   	        },
   	    });
        console.log("after call from  ajax call to endpoint url:    http://127.0.0.1:8000/apiperson/mathew/ " );
    }
    	    
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
    		var csrf_token = getCookie('csrftoken');
    		console.log("CSRFTOKEN: " + csrf_token);        	
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrf_token);
            }
        }
    }); //ajaxsetup

    //replace the click of a button to do a GET ajax REST call..
    $(".ButtonWrapperGET").find(":submit").click(
    	function (){
			ajaxREST("Mathew", "GET", null, function(result){
	            new_html = "<h2>" + result.last_name + '</h2><p>'+ result.first_name + '<p>' + result.email ;
	            console.log(new_html);
	            jQuery('#changeme').html(new_html).hide().fadeIn(1500);
	        })
	    });
	    
	    //replace the second button with a PUT request
	    $(".ButtonWrapperPUT").find(":submit").click(
        	function (){
    			ajaxREST("Mathew", "PUT", {first_name: "Mathew", last_name: "Zaleski", email:"z@zaleski.ca"}, function(result){
    	            console.log(result);
    	        });
   	    }); //click	    

	    
});//doc ready
</script>
</head>

<body>

<div id="changeme"><h2>Let jQuery AJAX Change This Text</h2></div>

<div class="ButtonWrapperGET">
  <button>GET person with first_name "Mathew"</button>
  <P>
   when you press the button contents of changeme change!
</div>

<h3>now try a PUT</h3>

<div class="ButtonWrapperPUT">
  <button>PUT email z@zaleski.ca to Mathew</button>
</div>

</body>
</html>





